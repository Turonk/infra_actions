name: Django-app workflow

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: | 
        # обновление pip
        python -m pip install --upgrade pip 
        # установка flake8 и его плагинов
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        # установка зависимостей
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8
        # перейти в папку, содержащую manage.py — 
        #<корневая_папка_infra_actions>/<папка_проекта>/manage.py
        cd infra_project/
        # запустить написанные разработчиком тесты
        python manage.py test
  
  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        # Запуск скрипта авторизации на Docker Hub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        # Пуш образа в Docker Hub 
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: ss1mpl3/infra_actions:latest
  
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: 
        -----BEGIN OPENSSH PRIVATE KEY-----
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
HlyROZb0ihgakikdTPv53Wmu49U=
-----END OPENSSH PRIVATE KEY-----
        passphrase: ${{ secrets.PASSPHRASE }}
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull ss1mpl3/infra_actions
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 ss1mpl3/infra_actions 
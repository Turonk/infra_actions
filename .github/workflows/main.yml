name: Django-app workflow

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: | 
        # обновление pip
        python -m pip install --upgrade pip 
        # установка flake8 и его плагинов
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        # установка зависимостей
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8
        # перейти в папку, содержащую manage.py — 
        #<корневая_папка_infra_actions>/<папка_проекта>/manage.py
        cd infra_project/
        # запустить написанные разработчиком тесты
        python manage.py test
    
  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        # Запуск скрипта авторизации на Docker Hub
        uses: docker/login-action@v1 
        with:
          username: borissv46
          password: DaryaPetrova1995
      - name: Push to Docker Hub
        # Пуш образа в Docker Hub 
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: borissv46/infraaction:latest 

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: 84.201.173.66
        username: admin
        key: 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
pnWmy4/x3gaN61Xey0qeFWeGsQw=
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull borissv46/infraaction
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 borissv46/infraaction
